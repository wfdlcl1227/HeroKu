<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">

</head>
<body>

    <style type='text/css'>
        .embeddedServiceHelpButton .helpButton .uiButton {
        background-color: #005290;
        font-family: "Arial", sans-serif;
        }
        
        .embeddedServiceHelpButton .helpButton .uiButton:focus {
        outline: 1px solid #005290;
        }
        
        .embeddedServiceLiveAgentStateChatPlaintextMessageDefaultUI.plaintextContent {
        margin-left: 0px !important;
        }
        
        /* .content {
        display: none !important;
        } */
        
        .avatar {
        display: none !important;
        }
        
        .embeddedServiceLiveAgentQueuePosition.queuePositionWaiting .youAreNextMessage {
        font-size: 20px !important;
        }
        
        .agentName {
        display: none !important;
        }
        
        .embeddedServiceSidebarMinimizedDefaultUI .minimizedText>.message {
        background-color: rgba(0, 0, 0, 0) !important;
        }
        
        .embeddedServiceSidebarMinimizedDefaultUI.sidebarHeader {
        bottom: 0 !important;
        }
        
        .queuePositionCounter.queuePositionNumber {
        display: none !important;
        }
        p[embeddedService-chatHeaderAnnouncement_chatHeaderAnnouncement]{
            position: absolute;
        }     

        @media all and (-ms-high-contrast: none),
        (-ms-high-contrast: active) {
        .queuePositionMessage {
        width: 15rem;
        }
        .sidebarHeader[embeddedService-chatHeader_chatHeader]{
            text-align: left;
        }        
        p[embeddedService-chatHeaderAnnouncement_chatHeaderAnnouncement]{
            position: relative;
            }             
        }
        .embeddedServiceSidebarMinimizedDefaultUI .queuePositionNumber {
            display: none;
        }
        </style>
        
    <!--[if IE]>
        <style type='text/css'>
            .queuePositionMessage{
                width: 15rem;
            }
            .sidebarHeader[embeddedService-chatHeader_chatHeader]{
                text-align: left;
            }   
             p[embeddedService-chatHeaderAnnouncement_chatHeaderAnnouncement]{
            position: relative;
            }
        </style>
    <![endif]-->  

<script type='text/javascript' >
    var initESW = function(gslbBaseURL) {
        embedded_svc.settings.buttonId = settings.buttonId;
        embedded_svc.settings.displayHelpButton = false;
        embedded_svc.settings.language = settings.language;
        embedded_svc.settings.enabledFeatures = ['LiveAgent'];
        embedded_svc.settings.entryFeature = 'LiveAgent';
        embedded_svc.settings.extraPrechatFormDetails = settings.extraPrechatFormDetails;
        embedded_svc.settings.extraPrechatInfo = [{
            "entityFieldMaps": [{
              "doCreate":false,
              "doFind":true,
              "fieldName":"Member_Number__c",
              "isExactMatch":true,
              "label":"Member Number"
            }],
            "entityName":"Account",
            "saveToTranscript": "AccountId",
          }];

        embedded_svc.addEventHandler("featureLoaded",
        function() {
            embedded_svc.onHelpButtonClick();
        }); 
                
        embedded_svc.addEventHandler("onChatEstablished", function(data) {
            console.log("onChatEstablished event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
            //need to be set
            //call salesforce api to get the survey url
            //Method： get, URI:/livechatsurvey/{data.liveAgentSessionKey}

            var xhr = new XMLHttpRequest();

            xhr.addEventListener("readystatechange", function () {
                settings.surveyURL = this.responseText.replace("\"","").replace("\"","");
            });
            var surveyEPURL = settings.surveyEndPointURL + data.liveAgentSessionKey;
            xhr.open("GET", surveyEPURL);
            xhr.send();  

        });



        embedded_svc.addEventHandler("onIdleTimeoutOccurred", function(data) {
            console.log("onIdleTimeoutClear event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
            switch (settings.language) {
                case "zh_CN":
                    showEndingMessage("是次对话已结束。如需任何协助，欢迎随时再与我们联络。");
                    break;
                case "zh_HK":
                    showEndingMessage("是次對話已結束。如需任何協助，歡迎隨時再與我們聯絡。");
                    break;
                default:
                    showEndingMessage("This chat has been ended. Feel free to contact us again if you need any help.");               
            }
        });          
         embedded_svc.addEventHandler("afterDestroy", function(data) {
            console.log("afterDestroy event was fired.  liveAgentSessionKey was ");
             //need to be set
            //replace the  survey url that generated in onChatEstablished event callback function
            var targetBtn = event.target.innerText;
            if(targetBtn == 'Contact Us' || targetBtn == '联络我们' || targetBtn == '聯絡我們' ){
                window.open("https://hkia.mp.sit.acnhk.com/"+settings.language+"/contact-us", "_blank"); 

            }

            if ((targetBtn == 'CLOSE CHAT' || targetBtn == '关闭' || targetBtn == '關閉') && settings.surveyURL && settings.surveyURL !== null) {
                var lan = settings.language.replace("_","-");
                window.open(settings.surveyURL + "&guestUserLang=" + lan, "_blank");
            }

          
        });           

        embedded_svc.addEventHandler("onQueueUpdate", function(data) {
            console.log('maxQueueNum==>' + settings.maxQueueNum);
            console.log('currentQueueNum==>' + settings.currentQueueNum);

            if(settings.maxQueueNum < settings.currentQueueNum){

                if(document.getElementById("lc-contact-btn")) return;

                var btn = document.createElement("button");
                btn.className = "dialogButton dialog-button-0 uiButton embeddedServiceSidebarButton";
                btn.id = "lc-contact-btn";
                switch (settings.language) {
                case "zh_CN":
                    btn.innerText = '联络我们';
                    break;
                case "zh_HK":
                    btn.innerText = '聯絡我們';
                    break;
                default:
                    btn.innerText = 'Contact Us';
                }
                btn.onclick = function(){
                    window.open("https://hkia.mp.sit.acnhk.com/"+settings.language+"/contact-us", "_blank"); 
                }
                document.querySelector("body > div.modalContainer.sidebarMaximized.layout-docked.embeddedServiceSidebar > div > div > div.activeFeature.hideWhileLoading > div > div > div > div.waitingStateButtonContainer").append(btn);
            }

        });

        embedded_svc.init(
            settings.myDomainURL,
            settings.communityURL,
            gslbBaseURL,
            settings.orgId,
            settings.eswLiveAgentDeploymentName,
            {
                baseLiveAgentContentURL: settings.baseLiveAgentContentURL,
                deploymentId: settings.deploymentId,
                buttonId: settings.buttonId,
                baseLiveAgentURL: settings.baseLiveAgentURL,
                eswLiveAgentDevName: settings.eswLiveAgentDevName,
                isOfflineSupportEnabled: false
            }
        );
    };

    function showEndingMessage(msg){
        var msgParentNode = document.querySelector("body > div.modalContainer.sidebarMaximized.layout-docked.embeddedServiceSidebar > div > div > div.activeFeature.hideWhileLoading > div > div > div.messageArea > ul > li:nth-last-child(1)");
        var newMsgNode = document.querySelector("body > div.modalContainer.sidebarMaximized.layout-docked.embeddedServiceSidebar > div > div > div.activeFeature.hideWhileLoading > div > div > div.messageArea > ul > li:nth-last-child(1) > div.chatContent").cloneNode(true);
        newMsgNode.firstChild.firstChild.innerText = msg;
        msgParentNode.append(newMsgNode);
    }


    function routeButton(){


        switch (settings.language) {
        case "zh_CN":
            settings.buttonId = "573O0000000Cb2x";//hardcode
            settings.eswLiveAgentDevName = "EmbeddedServiceLiveAgent_Parent04IO00000008OQ9MAM_1731266dd3e"; //hardcode
            settings.eswLiveAgentDeploymentName = "Live_Chat_LUX_SC";           
            break;
        case "zh_HK":
            settings.buttonId = "573O0000000Cb32";//hardcode
            settings.eswLiveAgentDevName = "EmbeddedServiceLiveAgent_Parent04IO00000008OQEMA2_1731270d8e1"; //hardcode
            settings.eswLiveAgentDeploymentName = "Live_Chat_LUX_TC";                
            break;
        default:
            settings.buttonId = "573O0000000Cb2s";//hardcode
            settings.eswLiveAgentDevName = "EmbeddedServiceLiveAgent_Parent04IO00000008OQJMA2_17312735dcb"; //hardcode
            settings.eswLiveAgentDeploymentName = "Live_Chat_LUX_EN";                
        }


    }


    var getCurrentQueueNumber = function() {
        var data = null;
        var xhr = new XMLHttpRequest();
        xhr.addEventListener("readystatechange", function () {
                if(this.responseText!=null && this.responseText !="" && this.responseText != 'undefined'){
                    var ret = JSON.parse(this.responseText);
                    if(ret.records[0].expr0!=null && ret.records[0].expr0 !="" && ret.records[0].expr0 != 'undefined'){
                        settings.currentQueueNum = ret.records[0].expr0;
                    }    
                    
                }
            });
        xhr.open("GET", "https://hkairportloyalty--sit.my.salesforce.com/services/data/v48.0/query/?q=Select+Count%28Id%29+from+PendingServiceRouting+where+IsPushed+=+false+and+IsReadyForRouting+=+true");
        xhr.setRequestHeader("Authorization", "Bearer 00DO00000053jxe!AQQAQJU22hSBjZmq8j1QSm4efGtC6VbclaHq2AJmR0MfgOcT72eM5NvrB_D0CRWD4jWFg6rzZlelyEYiHRVQnxjngQS4mggD");
        xhr.send(data);

    };


    var getMaxQueueNumber = function() {
        var data = null;
        var xhr = new XMLHttpRequest();
        xhr.addEventListener("readystatechange", function () {
                if(this.responseText!=null && this.responseText !="" && this.responseText != 'undefined'){
                    var ret = JSON.parse(this.responseText);
                    if(ret.records[0].LiveChat_Display_ContactUs_Number__c!=null && ret.records[0].LiveChat_Display_ContactUs_Number__c !="" && ret.records[0].LiveChat_Display_ContactUs_Number__c != 'undefined'){
                        settings.maxQueueNum = ret.records[0].LiveChat_Display_ContactUs_Number__c;
                    }
                }
            });

        xhr.open("GET", "https://hkairportloyalty--sit.my.salesforce.com/services/data/v48.0/query/?q=Select+LiveChat_Display_ContactUs_Number__c+from+Business_Settings__c+where+LiveChat_Display_ContactUs_Number__c+!=+NULL+LIMIT+1");
        xhr.setRequestHeader("Authorization", "Bearer 00DO00000053jxe!AQQAQJU22hSBjZmq8j1QSm4efGtC6VbclaHq2AJmR0MfgOcT72eM5NvrB_D0CRWD4jWFg6rzZlelyEYiHRVQnxjngQS4mggD");
        xhr.send(data);

    };

    function getQueueNumber(){
        getMaxQueueNumber();
        getCurrentQueueNumber();
    }

    var StartChat = function() {
            settings = {
                    env:"SIT",
                    //language:"zh_CN",//need to be set
                    channel:"HKairport Shop", //need to be set
                    membernumber:"", //need to be set
                    orgId:"00DO00000053jxe", //hardcode
                    deploymentId:"572O0000000Cb7T", //hardcode
                    myDomainURL:"https://hkairportloyalty--sit.my.salesforce.com", //hardcode
                    communityURL:"https://sit-hkairportrewards.cs5.force.com/hkairportrewards", //hardcode
                    eswJSURL:"https://hkairportloyalty--sit.my.salesforce.com/embeddedservice/5.0/esw.min.js", //hardcode
                    gslbBaseURL:"https://service.force.com", //hardcode
                    surveyURL:"", //hardcode
                    surveyEndPointURL:"https://sit.api.iss.acnhk.com/loyalty/survey/liveChatUrl/", //hardcode
                    baseLiveAgentURL:"https://d.la1-c1cs-hnd.salesforceliveagent.com/chat", //hardcode
                    baseLiveAgentContentURL:"https://c.la1-c1cs-hnd.salesforceliveagent.com/content", //hardcode
                    extraPrechatFormDetails:[],
                    currentQueueNum:0, //NO need to be set
                    maxQueueNum:0, //NO need to be set
                    }

        var e = window.event;                
        //For EMP this is Luxury Reserve
        settings.buttonType = 'Luxury Reserve';//hardcode
        //For EMP this is Luxury Reserve
        //settings.buttonType = 'General Inquery';//hardcode

        settings.language = document.getElementById("languageSelect").value;

        settings.extraPrechatFormDetails = [{"label": "Member Number","value": settings.membernumber,"displayToAgent": true},
                             {"label": "language","value": settings.language ,"displayToAgent": true, "transcriptFields": ["Preferred_Communication_Language__c"],},
                             {"label": "Chat Type","value": settings.buttonType,"displayToAgent": true, "transcriptFields": ["Type__c"],},
                             {"label": "Chat Channel","value": settings.channel,"displayToAgent": true, "transcriptFields": ["Channel__c"],}];         

        // get current queue number and max queue number
        getQueueNumber();

        if (!window.embedded_svc) {
            var s = document.createElement('script');
            s.setAttribute('src', settings.eswJSURL);
            s.setAttribute('sandbox', 'allow-top-navigation allow-same-origin allow-forms allow-scripts');
            s.onload = function() {
                routeButton();
                initESW(null);
            };
            document.body.appendChild(s);
        } else {
            routeButton();
            embedded_svc.settings.language = document.getElementById("languageSelect").value ;
            embedded_svc.settings.directToButtonRouting = function() {
                    return settings.buttonId;
            }
            embedded_svc.onHelpButtonClick();
        }
    }

</script>

<select id="languageSelect">
  <option value="en_US">en_US</option>
  <option value ="zh_CN">zh_CN</option>
  <option value ="zh_HK">zh_HK</option>
</select><br/><br/><br/>
<button type="button" onclick="StartChat()">Lux</button>
</body>
</html>
